#!/bin/bash

# Exit on error and unset variables
set -eu

# Check if running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run with sudo privileges" >&2
    exit 1
fi

# Get the actual user (not root)
REAL_USER=$(logname)
echo "Installing for user: $REAL_USER"

# Fix conflicting apt sources
cleanup_conflicting_sources() {
    echo "Cleaning up conflicting repository sources..."
    # Remove all existing Microsoft repo configurations
    rm -f /etc/apt/sources.list.d/vscode.list
    rm -f /etc/apt/sources.list.d/microsoft*.list
    # Remove conflicting keyrings
    rm -f /etc/apt/trusted.gpg.d/microsoft*.gpg
    rm -f /usr/share/keyrings/microsoft*.gpg
    rm -f /etc/apt/keyrings/packages.microsoft.gpg
}

# Install dependencies
echo "Updating packages and installing dependencies..."
apt update && apt install -y wget gpg apt-transport-https

# Clean up any conflicting sources
cleanup_conflicting_sources

# Download and install Microsoft GPG key
echo "Adding Microsoft repository..."
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
install -D -o root -g root -m 644 packages.microsoft.gpg /usr/share/keyrings/microsoft.gpg
rm -f packages.microsoft.gpg

# Add VSCode repository
echo "deb [arch=amd64,arm64,armhf signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main" | tee /etc/apt/sources.list.d/vscode.list >/dev/null

# Install VSCode
echo "Installing VSCode..."
apt update && apt install -y code

# Fix PAM/sudo issues for tunnel service
echo "Configuring code tunnel service..."
SERVICE_FILE="/etc/systemd/system/code-tunnel.service"

cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=VSCode Tunnel Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/code tunnel
Restart=always
RestartSec=3
User=$REAL_USER
Environment="PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
WorkingDirectory=/home/$REAL_USER
PAMName=login

# Important security context for sudo to work
UMask=0077
NoNewPrivileges=no
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

# Set proper permissions
chmod 644 "$SERVICE_FILE"

# Reload systemd
systemctl daemon-reload
systemctl enable code-tunnel.service

echo "Starting tunnel service..."
systemctl start code-tunnel.service

# Configure sudo access (fixes PAM issues)
echo "Configuring sudo access for $REAL_USER..."
echo "$REAL_USER ALL=(ALL) NOPASSWD:ALL" | tee /etc/sudoers.d/vscode-tunnel-user

echo "Installation complete. VS Code Tunnel will start automatically on boot."
echo "Note: You need to authenticate once by running:"
echo "  code tunnel login"
echo "After authentication, start the service with:"
echo "  sudo systemctl start code-tunnel.service"